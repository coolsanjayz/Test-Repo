$BaseUrl      = "https://anypoint.mulesoft.com"
$ClientId     = "<CLIENT_ID>"
$ClientSecret = "<CLIENT_SECRET>"

$OrgId = "<ORG_ID>"
$EnvId = "<DEV_ENV_ID>"
$ApiId = "<API_INSTANCE_ID>"

# Token
$tokenResponse = Invoke-RestMethod -Method POST `
  -Uri "$BaseUrl/accounts/api/v2/oauth2/token" `
  -ContentType "application/x-www-form-urlencoded" `
  -Body @{
    grant_type    = "client_credentials"
    client_id     = $ClientId
    client_secret = $ClientSecret
  }

$AccessToken = $tokenResponse.access_token
$headers = @{ Authorization = "Bearer $AccessToken" }

# Automated policies for that API instance
$autoPolicies = Invoke-RestMethod -Method GET `
  -Uri "$BaseUrl/apimanager/api/v1/organizations/$OrgId/automated-policies?environmentId=$EnvId&apiInstanceId=$ApiId" `
  -Headers $headers

$autoPolicies | ConvertTo-Json -Depth 80
